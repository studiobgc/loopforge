import { useCallback, useEffect, useMemo, useState } from 'react'
import { useDropzone } from 'react-dropzone'
import { PeaksWaveform } from './components/audio/PeaksWaveform'
import { forgeApi } from './api/forgeApi'
import { ProcessingConfig, VocalSettings, LoopViewModel } from './types/forge'
import { RetroButton, RetroCheckbox, LCDDisplay, RetroSelect } from './components/ui/RetroControls'
import { GrooveTransferPanel } from './components/GrooveTransferPanel'
import { SessionPlayer } from './components/SessionPlayer'
import { ProcessingQueue } from './components/ProcessingQueue'

const ROLE_OPTIONS = [
    { id: 'drums', label: 'DRUMS' },
    { id: 'vocals', label: 'VOCALS' },
    { id: 'bass', label: 'BASS' },
    { id: 'melody', label: 'MELODY' }
] as const

type Role = typeof ROLE_OPTIONS[number]['id']

type ProcessingTask = {
    id: string
    filename: string
    status: 'uploading' | 'processing' | 'complete' | 'error'
    progress: number
    message?: string
    error?: string
}

type SourceTrack = {
    id: string
    file: File
    filename: string
    role: Role | null
    key?: string
    mode?: string
    bpm?: number | null
    tags?: string[]
}

const ENGINE_TAGS = ['DEMUCS v4', 'RUBBERBAND', 'SILERO VAD', 'LOOP FACTORY V4', 'DSP MUTATION']

export default function DualDeckWorkstation() {
    // Processing Queue (replaces phase system)
    const [processingTasks, setProcessingTasks] = useState<ProcessingTask[]>([])

    // Session State
    const [sources, setSources] = useState<SourceTrack[]>([])
    const [sessionId, setSessionId] = useState<string | null>(null)
    const [loops, setLoops] = useState<LoopViewModel[]>([])
    const [playingId, setPlayingId] = useState<string | null>(null)
    const [downloadStatus, setDownloadStatus] = useState<string>('')
    const [logs, setLogs] = useState<string[]>([])

    const [quality, setQuality] = useState<'standard' | 'high'>('standard')
    const [masterKey, setMasterKey] = useState<string>('C')
    const [masterMode, setMasterMode] = useState<string>('minor')
    const [masterBpm, setMasterBpm] = useState<number | null>(null)

    // DUAL-ANCHOR SYSTEM (Chimera Protocol)
    const [rhythmAnchor, setRhythmAnchor] = useState<string | null>(null)  // Track for BPM reference
    const [harmonicAnchor, setHarmonicAnchor] = useState<string | null>(null)  // Track for Key reference

    // Vocal FX State
    const [vocalSettings] = useState<VocalSettings>({
        correction_strength: 0.8,
        formant_shift: 0,
        pitch_wobble: 0,
        stutter_intensity: 0,
        bitcrush_depth: 24,
        phase_smear: 0
    })

    const addLog = (msg: string) => setLogs(prev => [`> ${msg}`, ...prev].slice(0, 50))

    // Persistence Logic
    useEffect(() => {
        const saved = localStorage.getItem('forge_session')
        if (saved) {
            try {
                const data = JSON.parse(saved)
                if (data.sessionId) setSessionId(data.sessionId)
                if (data.loops) setLoops(data.loops)
                if (data.logs) setLogs(data.logs)
            } catch (e) {
                console.error('Failed to restore session', e)
            }
        }
    }, [])

    useEffect(() => {
        if (sessionId) {
            localStorage.setItem('forge_session', JSON.stringify({
                sessionId,
                loops,
                logs
            }))
        }
    }, [sessionId, loops, logs])

    const resumePolling = (sid: string, taskId: string) => {
        let lastMsg = ''
        const poll = setInterval(async () => {
            try {
                const data = await forgeApi.getStatus(sid).catch(() => null)
                if (!data) return

                // Update processing task progress
                if (data.track_progress) {
                    setProcessingTasks(prev => prev.map(task => {
                        if (task.id === taskId) {
                            const overallProgress = Object.values(data.track_progress as Record<string, any>)
                                .reduce((sum: number, t: any) => sum + (t.progress || 0), 0) /
                                Object.keys(data.track_progress).length
                            return {
                                ...task,
                                progress: overallProgress,
                                status: 'processing' as const
                            }
                        }
                        return task
                    }))
                }

                if (data.message && data.message !== lastMsg) {
                    lastMsg = data.message
                    addLog(data.message)
                }

                if (data.status === 'complete') {
                    clearInterval(poll)
                    if (data.results) {
                        const newLoops: LoopViewModel[] = data.results.map((r: any) => ({
                            id: r.filename,
                            filename: r.filename,
                            role: r.role,
                            bpm: r.bpm || 120,
                            key: r.key || 'C min',
                            path: r.path,
                            bars: r.bars || 4,
                            selected: true,
                            duration: r.duration || null,
                            cropStart: 0,
                            cropEnd: r.duration || 0,
                            gain: 0,
                            loopPlayback: true,
                            transients: r.transients || [],
                            tags: r.tags || [],
                            texture: r.texture,
                            dna: r.dna,
                            shift_amount: r.shift_amount,
                            effect_chain: r.effect_chain,
                            peaks_filename: r.peaks_filename,
                            peaks_path: r.peaks_path
                        }))
                        setLoops(prev => [...prev, ...newLoops])
                    }
                    setProcessingTasks(prev => prev.map(task =>
                        task.id === taskId ? { ...task, status: 'complete' as const, progress: 100 } : task
                    ))
                    setDownloadStatus('ready')
                    addLog('‚úÖ Processing complete!')
                } else if (data.status === 'error') {
                    clearInterval(poll)
                    setProcessingTasks(prev => prev.map(task =>
                        task.id === taskId ? { ...task, status: 'error' as const, error: data.message } : task
                    ))
                    addLog(`Error: ${data.message || 'Unknown error'}`)
                }
            } catch (e: any) {
                console.error('Poll error', e)
                if (e.response && e.response.status === 404) {
                    clearInterval(poll)
                    setProcessingTasks(prev => prev.map(task =>
                        task.id === taskId ? { ...task, status: 'error' as const, error: 'Session lost' } : task
                    ))
                    addLog('error: session lost (server restarted?)')
                }
            }
        }, 1000)
    }

    const onDrop = useCallback((acceptedFiles: File[]) => {
        setSources(prev => {
            const newSources: SourceTrack[] = []
            const existingNames = new Set(prev.map(s => s.filename))

            acceptedFiles.forEach(file => {
                let name = file.name
                let counter = 1
                // Rename if duplicate
                while (existingNames.has(name)) {
                    const parts = file.name.split('.')
                    const ext = parts.pop()
                    const base = parts.join('.')
                    name = `${base} (${counter}).${ext}`
                    counter++
                }
                existingNames.add(name)

                // Create a new File object with the unique name if it changed
                const uniqueFile = name !== file.name
                    ? new File([file], name, { type: file.type })
                    : file

                newSources.push({
                    id: crypto.randomUUID(), // Unique ID for React key
                    file: uniqueFile,
                    filename: name, // Unique filename for backend
                    role: null
                })
            })
            return [...prev, ...newSources]
        })
        addLog(`queued ${acceptedFiles.length} files`)
    }, [])

    const { getRootProps, getInputProps, isDragActive } = useDropzone({
        onDrop,
        accept: { 'audio/*': ['.wav', '.mp3', '.aiff', '.flac', '.m4a'] }
    })

    const setRole = (id: string, role: Role | null) => {
        setSources(prev => prev.map(track => (track.id === id ? { ...track, role } : track)))
    }

    const removeTrack = (id: string) => {
        setSources(prev => prev.filter(track => track.id !== id))
    }





    const updateCrop = (filename: string, start: number, end: number) => {
        setLoops(prev =>
            prev.map(loop =>
                loop.filename === filename
                    ? { ...loop, cropStart: Math.max(0, start), cropEnd: Math.min(loop.duration || end, end) }
                    : loop
            )
        )
    }

    const evolveTrack = async (track: SourceTrack) => {
        if (!sessionId || !track.tags) return
        addLog(`evolving ${track.file.name} based on tags: [${track.tags.join(', ')}]...`)
        try {
            const result = await forgeApi.evolveTrack(sessionId, track.file.name, track.tags)
            const viewModel: LoopViewModel = {
                ...result,
                bpm: track.bpm || 120,
                key: track.key ? `${track.key} ${track.mode || ''}` : 'C min',
                selected: true,
                duration: null,
                cropStart: 0,
                cropEnd: 0,
                gain: 0,
                loopPlayback: true,
                transients: []
            }
            setLoops(prev => [viewModel, ...prev])
            addLog(`evolution complete: ${result.filename}`)
        } catch (e: any) {
            addLog(`evolution failed: ${e.message}`)
        }
    }

    const startProcessing = async () => {
        if (!sources.length) return
        const hasRoles = sources.some(s => s.role)
        if (!hasRoles) return

        const taskId = crypto.randomUUID()
        const taskFilenames = sources.map(s => s.filename).join(', ')

        // Create processing task
        setProcessingTasks(prev => [...prev, {
            id: taskId,
            filename: taskFilenames,
            status: 'uploading',
            progress: 0,
            message: 'Uploading files...'
        }])

        addLog('üöÄ Starting forge session...')

        try {
            const uploadData = await forgeApi.uploadFiles(sources.map(s => s.file))
            const newSessionId = uploadData.session_id
            setSessionId(newSessionId)
            addLog(`‚úÖ Session created: ${newSessionId.slice(0, 8)}`)

            const roleMap: Record<string, string> = {}
            sources.forEach(track => {
                if (track.role) roleMap[track.file.name] = track.role
            })

            if (uploadData.sources) {
                setSources(prev => prev.map(track => {
                    const analysis = uploadData.sources.find((s: any) => s.filename === track.file.name)
                    if (analysis) {
                        return {
                            ...track,
                            key: analysis.key,
                            mode: analysis.mode,
                            bpm: analysis.bpm,
                            tags: analysis.tags
                        }
                    }
                    return track
                }))
            }

            setProcessingTasks(prev => prev.map(task =>
                task.id === taskId ? { ...task, status: 'processing', message: 'Processing stems...' } : task
            ))
            addLog('üéõÔ∏è Demucs v4 model loaded')

            const config: ProcessingConfig = {
                rhythm_anchor_filename: rhythmAnchor || undefined,
                harmonic_anchor_filename: harmonicAnchor || undefined,
                target_bpm: masterBpm || undefined,
                target_key: masterKey,
                target_mode: masterMode,
                roles: roleMap,
                enabled_presets: [],
                crops: {},
                quality: quality,
                vocal_settings: vocalSettings
            }

            await forgeApi.startProcessing(newSessionId, config)

            resumePolling(newSessionId, taskId)

            // Clear sources after starting processing (non-blocking)
            setSources([])
        } catch (e: any) {
            console.error(e)
            setProcessingTasks(prev => prev.map(task =>
                task.id === taskId ? { ...task, status: 'error', error: e.message } : task
            ))
            addLog(`‚ùå Error: ${e.message}`)
        }
    }
}

const selectedLoops = useMemo(() => loops.filter(loop => loop.selected), [loops])

const downloadSelection = async () => {
    if (!sessionId || !selectedLoops.length) return
    setDownloadStatus('processing export...')
    addLog('exporting cropped loops...')
    try {
        const loopsToExport = selectedLoops.map(l => ({
            filename: l.filename,
            crop_start: l.cropStart || 0,
            crop_end: l.cropEnd || l.duration || 0
        }))

        const blob = await forgeApi.exportLoops(sessionId, loopsToExport)
        const url = window.URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = 'loop_forge_pack.zip'
        document.body.appendChild(a)
        a.click()
        window.URL.revokeObjectURL(url)
        document.body.removeChild(a)

        setDownloadStatus('ready')
        addLog('export complete')
    } catch (e) {
        console.error(e)
        setDownloadStatus('error')
        addLog('export failed')
        setTimeout(() => setDownloadStatus('ready'), 3000)
    }
}



const clearSession = () => {
    setSessionId(null)
    setLoops([])
    setSources([])
    setPhase('collect')
    setStage('idle')
    setLogs([])
    localStorage.removeItem('forge_session')
}

// --- MIXER STATE ---
const [mixerState, setMixerState] = useState<Record<string, { mute: boolean, solo: boolean, vol: number }>>({})
const [isPlayingAll, setIsPlayingAll] = useState(false)

useEffect(() => {
    setMixerState(prev => {
        const next = { ...prev }
        loops.forEach(l => {
            if (!next[l.filename]) next[l.filename] = { mute: false, solo: false, vol: 1.0 }
        })
        return next
    })
}, [loops])

const toggleMute = (filename: string) => {
    setMixerState(prev => ({
        ...prev,
        [filename]: { ...prev[filename], mute: !prev[filename].mute }
    }))
}

const toggleSolo = (filename: string) => {
    setMixerState(prev => {
        const isSolo = !prev[filename].solo
        return {
            ...prev,
            [filename]: { ...prev[filename], solo: isSolo }
        }
    })
}

const togglePlayAll = () => {
    if (isPlayingAll) {
        loops.forEach(l => {
            const audio = document.getElementById(`audio-${l.filename}`) as HTMLAudioElement
            if (audio) {
                audio.pause()
                audio.currentTime = 0
            }
        })
        setIsPlayingAll(false)
        setPlayingId(null)
    } else {
        loops.forEach(l => {
            const audio = document.getElementById(`audio-${l.filename}`) as HTMLAudioElement
            if (audio) {
                audio.currentTime = l.cropStart || 0
                audio.play()
            }
        })
        setIsPlayingAll(true)
    }
}

// Add selection state for sources
const [selectedSourceId, setSelectedSourceId] = useState<string | null>(null)

// Enhanced Key Handler
useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
        if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) return

        // DELETE
        if (e.key === 'Delete' || e.key === 'Backspace') {
            if (selectedSourceId) {
                removeTrack(selectedSourceId)
                setSelectedSourceId(null)
            }
        }

        // DUPLICATE (Cmd+D)
        if ((e.metaKey || e.ctrlKey) && e.key === 'd') {
            e.preventDefault()
            if (selectedSourceId) {
                const source = sources.find(s => s.id === selectedSourceId)
                if (source) {
                    const newSource = {
                        ...source,
                        id: crypto.randomUUID(),
                        filename: source.filename.replace(/(\.[^.]+)$/, ' (copy)$1')
                    }
                    setSources(prev => [...prev, newSource])
                }
            }
        }
    }

    window.addEventListener('keydown', handleKeyDown)
    return () => window.removeEventListener('keydown', handleKeyDown)
}, [selectedSourceId, sources])

return (
    <div className="app-shell" onClick={() => setSelectedSourceId(null)}>
        {/* HEADER */}
        <header className="rack-header">
            <div className="flex-col">
                <div className="brand-logo">LOOP FORGE <span style={{ color: 'var(--accent-primary)' }}>2.0</span></div>
                <div style={{ fontSize: 9, color: '#666' }}>PROCESS-FIRST WORKSTATION</div>
            </div>

            <div className="flex-center gap-4">
                <div className="flex gap-2">
                    {ENGINE_TAGS.map(tag => (
                        <span key={tag} style={{ fontSize: 9, color: '#444', border: '1px solid #222', padding: '2px 4px', borderRadius: 2 }}>{tag}</span>
                    ))}
                </div>
                <RetroButton
                    active={isPlayingAll}
                    onClick={togglePlayAll}
                    style={{ width: 100 }}
                >
                    {isPlayingAll ? '‚ñ† STOP ALL' : '‚ñ∂ PLAY ALL'}
                </RetroButton>
            </div>
        </header>

        {/* WORKSPACE */}
        <div className="rack-workspace">
            {/* SIDEBAR */}
            <aside className="rack-sidebar">
                <div className="sidebar-header flex justify-between items-center">
                    <span>Source Deck</span>
                    <RetroButton onClick={clearSession} style={{ fontSize: 9, padding: '2px 6px' }}>RESET</RetroButton>
                </div>

                <div
                    {...getRootProps()}
                    className="flex-center flex-col"
                    style={{
                        padding: 20,
                        borderBottom: '1px solid #000',
                        background: isDragActive ? 'rgba(191, 244, 106, 0.05)' : 'transparent',
                        cursor: 'pointer'
                    }}
                >
                    <input {...getInputProps()} />
                    <div style={{ color: '#666', fontSize: 10 }}>DROP STEMS HERE</div>
                </div>

                <div className="flex-col gap-2 p-2 overflow-y-auto flex-1">
                    {sources.map((track, index) => (
                        <div
                            key={track.id}
                            className={`vst-panel relative group ${selectedSourceId === track.id ? 'border-[var(--accent-primary)]' : ''}`}
                            style={{ padding: 8 }}
                            draggable
                            onClick={(e) => {
                                e.stopPropagation()
                                setSelectedSourceId(track.id)
                            }}
                            onDragStart={(e) => {
                                e.dataTransfer.setData('text/plain', index.toString())
                                e.dataTransfer.effectAllowed = 'move'
                            }}
                            onDragOver={(e) => e.preventDefault()}
                            onDrop={(e) => {
                                e.preventDefault()
                                const fromIndex = parseInt(e.dataTransfer.getData('text/plain'))
                                const toIndex = index
                                if (fromIndex === toIndex) return

                                setSources(prev => {
                                    const next = [...prev]
                                    const [moved] = next.splice(fromIndex, 1)
                                    next.splice(toIndex, 0, moved)
                                    return next
                                })
                            }}
                            onContextMenu={(e) => {
                                e.preventDefault()
                                setSelectedSourceId(track.id) // Auto-select on right click
                                // Simple custom context menu logic
                                // In a real app, use a portal or dedicated component
                                // For now, let's use a native-like overlay
                                const menu = document.createElement('div')
                                menu.className = 'fixed bg-[#222] border border-[#444] shadow-xl z-50 flex flex-col py-1 rounded'
                                menu.style.left = `${e.clientX}px`
                                menu.style.top = `${e.clientY}px`

                                const options = [
                                    {
                                        label: 'Rename', action: () => {
                                            const newName = prompt('Rename track:', track.filename)
                                            if (newName) {
                                                setSources(prev => prev.map(t => t.id === track.id ? { ...t, filename: newName } : t))
                                            }
                                        }
                                    },
                                    {
                                        label: 'Duplicate', action: () => {
                                            const newSource = {
                                                ...track,
                                                id: crypto.randomUUID(),
                                                filename: track.filename.replace(/(\.[^.]+)$/, ' (copy)$1')
                                            }
                                            setSources(prev => [...prev, newSource])
                                        }
                                    },
                                    {
                                        label: 'Set as Rhythm Anchor', action: () => {
                                            setRhythmAnchor(track.filename)
                                            if (track.bpm) setMasterBpm(track.bpm)
                                        }
                                    },
                                    {
                                        label: 'Set as Harmonic Anchor', action: () => {
                                            setHarmonicAnchor(track.filename)
                                            if (track.key) setMasterKey(track.key)
                                            if (track.mode) setMasterMode(track.mode)
                                        }
                                    },
                                    { label: 'Delete', action: () => removeTrack(track.id), danger: true }
                                ]

                                options.forEach(opt => {
                                    const item = document.createElement('div')
                                    item.textContent = opt.label
                                    item.className = `px-4 py-2 text-xs cursor-pointer hover:bg-[#333] ${opt.danger ? 'text-red-400' : 'text-gray-200'}`
                                    item.onclick = () => {
                                        opt.action()
                                        document.body.removeChild(menu)
                                    }
                                    menu.appendChild(item)
                                })

                                // Close on click outside
                                const close = () => {
                                    if (document.body.contains(menu)) document.body.removeChild(menu)
                                    window.removeEventListener('click', close)
                                }
                                setTimeout(() => window.addEventListener('click', close), 0)

                                document.body.appendChild(menu)
                            }}
                        >
                            {/* Drag Handle */}
                            <div className="absolute left-1 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-50 cursor-grab active:cursor-grabbing text-[#666]">
                                ‚ãÆ‚ãÆ
                            </div>

                            {/* Anchor Badges */}
                            <div className="flex gap-1 mb-2 pl-4">
                                {rhythmAnchor === track.filename && (
                                    <div style={{
                                        fontSize: 8,
                                        padding: '2px 6px',
                                        background: 'rgba(191, 244, 106, 0.1)',
                                        border: '1px solid var(--accent-primary)',
                                        color: 'var(--accent-primary)',
                                        borderRadius: 2,
                                        fontWeight: 700
                                    }}>
                                        ü•Å RHYTHM ANCHOR ({track.bpm} BPM)
                                    </div>
                                )}
                                {harmonicAnchor === track.filename && (
                                    <div style={{
                                        fontSize: 8,
                                        padding: '2px 6px',
                                        background: 'rgba(74, 158, 255, 0.1)',
                                        border: '1px solid #4a9eff',
                                        color: '#4a9eff',
                                        borderRadius: 2,
                                        fontWeight: 700
                                    }}>
                                        üéπ HARMONIC ANCHOR ({track.key} {track.mode})
                                    </div>
                                )}
                            </div>

                            <div className="flex justify-between items-center mb-2 pl-4">
                                <div style={{ fontSize: 10, fontWeight: 700, color: '#fff', maxWidth: 120, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                    {track.filename}
                                </div>
                                <button onClick={(e) => { e.stopPropagation(); removeTrack(track.id) }} style={{ color: '#666', cursor: 'pointer' }}>‚úï</button>
                            </div>

                            <div className="flex gap-2 mb-2 pl-4">
                                <RetroSelect
                                    value={track.role || ''}
                                    onChange={(val) => setRole(track.id, val as Role)}
                                    options={ROLE_OPTIONS.map(r => ({ value: r.id, label: r.label }))}
                                    placeholder="SELECT ROLE"
                                    style={{ width: '100%' }}
                                />
                            </div>

                            {/* Meta Display */}
                            <div className="flex gap-2 mb-2 pl-4">
                                <div className="flex-col flex-1">
                                    <LCDDisplay label="KEY" text={track.key ? `${track.key} ${track.mode || ''}` : '--'} />
                                </div>
                                <div className="flex-col flex-1">
                                    <LCDDisplay label="BPM" text={track.bpm ? String(Math.round(track.bpm)) : '--'} />
                                </div>
                            </div>

                            {/* Progress */}
                            {trackProgress[track.file.name] && (
                                <div className="ml-4" style={{ height: 4, background: '#000', borderRadius: 2, overflow: 'hidden' }}>
                                    <div style={{ width: `${trackProgress[track.file.name].progress}%`, height: '100%', background: 'var(--accent-primary)' }} />
                                </div>
                            )}

                            {/* Dual-Anchor Controls */}
                            <div className="flex gap-1 mt-2 pl-4">
                                <RetroButton
                                    active={rhythmAnchor === track.filename}
                                    onClick={(e) => {
                                        e.stopPropagation()
                                        if (rhythmAnchor === track.filename) {
                                            // Toggle off
                                            setRhythmAnchor(null)
                                            addLog(`ü•Å Rhythm anchor cleared`)
                                        } else {
                                            // Toggle on
                                            setRhythmAnchor(track.filename)
                                            if (track.bpm) setMasterBpm(track.bpm)
                                            addLog(`ü•Å Rhythm anchor: ${track.filename} (${track.bpm} BPM)`)
                                        }
                                    }}
                                    style={{ flex: 1, fontSize: 8, padding: '3px 4px' }}
                                >
                                    ü•Å BPM
                                </RetroButton>
                                <RetroButton
                                    active={harmonicAnchor === track.filename}
                                    onClick={(e) => {
                                        e.stopPropagation()
                                        if (harmonicAnchor === track.filename) {
                                            // Toggle off
                                            setHarmonicAnchor(null)
                                            addLog(`üéπ Harmonic anchor cleared`)
                                        } else {
                                            // Toggle on
                                            setHarmonicAnchor(track.filename)
                                            if (track.key) setMasterKey(track.key)
                                            if (track.mode) setMasterMode(track.mode)
                                            addLog(`üéπ Harmonic anchor: ${track.filename} (${track.key} ${track.mode})`)
                                        }
                                    }}
                                    style={{ flex: 1, fontSize: 8, padding: '3px 4px' }}
                                >
                                    üéπ KEY
                                </RetroButton>
                                {track.tags && track.tags.length > 0 && (
                                    <RetroButton
                                        variant="primary"
                                        onClick={(e) => { e.stopPropagation(); evolveTrack(track) }}
                                        style={{ flex: 1, fontSize: 9 }}
                                    >
                                        EVOLVE
                                    </RetroButton>
                                )}
                            </div>
                        </div>
                    ))}
                </div>

                {/* Master Settings Panel */}
                <div className="vst-panel m-2 p-2">
                    <div className="vst-panel-title mb-2">MASTER SETTINGS</div>
                    <div className="flex gap-2">
                        <div className="flex-col flex-1">
                            <RetroSelect
                                label="KEY"
                                value={masterKey}
                                onChange={setMasterKey}
                                options={['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'].map(k => ({ value: k, label: k }))}
                            />
                        </div>
                        <div className="flex-col flex-1">
                            <RetroSelect
                                label="MODE"
                                value={masterMode}
                                onChange={setMasterMode}
                                options={[
                                    { value: 'major', label: 'Major' },
                                    { value: 'minor', label: 'Minor' }
                                ]}
                            />
                        </div>
                        <div className="flex-col gap-1" style={{ width: 80 }}>
                            <label className="text-xs text-dim font-bold">BPM</label>
                            <input
                                type="number"
                                className="retro-input"
                                value={masterBpm || ''}
                                placeholder="AUTO"
                                onChange={e => setMasterBpm(e.target.value ? parseInt(e.target.value) : null)}
                                style={{ width: '100%', height: 24, fontSize: 11 }}
                            />
                        </div>
                    </div>

                    <div className="mt-2">
                        <RetroCheckbox
                            label="HIGH QUALITY (ENSEMBLE)"
                            checked={quality === 'high'}
                            onChange={c => setQuality(c ? 'high' : 'standard')}
                        />
                    </div>
                </div>

                <div className="p-2">
                    <RetroButton
                        variant="primary"
                        style={{ width: '100%', height: 40, fontSize: 12 }}
                        onClick={startProcessing}
                        disabled={!sources.length || !sources.some(s => s.role) || phase === 'processing'}
                    >
                        {phase === 'processing' ? 'PROCESSING...' : 'PROCESS SESSION'}
                    </RetroButton>
                </div>
            </aside>

            {/* MAIN RACK */}
            <main className="rack-main">
                {phase === 'review' && loops.length === 0 && (
                    <div className="flex-center h-full text-dim">NO LOOPS GENERATED</div>
                )}

                {phase !== 'review' && (
                    <div className="flex-center flex-col h-full gap-6" style={{
                        background: phase === 'processing' ? 'rgba(0,0,0,0.2)' : 'transparent',
                        transition: 'background 0.3s ease'
                    }}>
                        {phase === 'collect' ? (
                            <div className="flex-center flex-col gap-4 opacity-50">
                                <div style={{
                                    width: 80, height: 80,
                                    border: '2px dashed #444',
                                    borderRadius: 8,
                                    display: 'flex', alignItems: 'center', justifyContent: 'center'
                                }}>
                                    <span style={{ fontSize: 32, color: '#444' }}>+</span>
                                </div>
                                <div className="text-center">
                                    <div style={{ fontSize: 14, fontWeight: 700, color: '#666' }}>DROP STEMS TO BEGIN</div>
                                    <div style={{ fontSize: 10, color: '#444', marginTop: 4 }}>SUPPORTS WAV, MP3, FLAC, AIFF</div>
                                </div>
                            </div>
                        ) : (
                            <div className="flex-center flex-col gap-4 w-full max-w-md">
                                <div className="flex justify-between w-full items-end mb-2">
                                    <div style={{ fontSize: 12, fontWeight: 700, color: 'var(--accent-primary)' }}>
                                        PROCESSING SESSION...
                                    </div>
                                    <div style={{ fontSize: 10, color: '#666', fontFamily: 'var(--font-mono)' }}>
                                        {progress}%
                                    </div>
                                </div>

                                {/* Progress Bar */}
                                <div style={{
                                    width: '100%', height: 4,
                                    background: '#111',
                                    borderRadius: 2,
                                    overflow: 'hidden',
                                    marginBottom: 16
                                }}>
                                    <div style={{
                                        width: `${progress}%`,
                                        height: '100%',
                                        background: 'var(--accent-primary)',
                                        boxShadow: '0 0 10px var(--accent-primary)',
                                        transition: 'width 0.2s ease-out'
                                    }} />
                                </div>

                                {/* Terminal Log */}
                                <div className="lcd-screen w-full" style={{
                                    height: 200,
                                    padding: 12,
                                    display: 'flex',
                                    flexDirection: 'column-reverse', // Newest at bottom if we want, or top. 
                                    // Actually logs are [newest, ...old], so column is fine if we want newest at top.
                                    // But terminal usually has newest at bottom.
                                    // Let's keep it simple.
                                    overflowY: 'auto',
                                    fontSize: 10,
                                    lineHeight: 1.4,
                                    opacity: 0.8
                                }}>
                                    {logs.map((log, i) => (
                                        <div key={i} style={{
                                            color: i === 0 ? '#fff' : '#666',
                                            marginBottom: 2
                                        }}>
                                            {log}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                )}

                {phase === 'review' && loops.map(loop => {
                    const mix = mixerState[loop.filename] || { mute: false, solo: false, vol: 1.0 }
                    const isMuted = mix.mute || (Object.values(mixerState).some(m => m.solo) && !mix.solo)

                    return (
                        <div key={loop.filename} className="relative mb-4">
                            <PeaksWaveform
                                audioUrl={`/api/forge/stream/${sessionId}/${loop.filename}`}
                                peaksUrl={loop.peaks_filename ? `/api/forge/peaks/${sessionId}/${loop.peaks_filename}` : undefined}
                                isPlaying={playingId === loop.filename}
                                isLooping={loop.loopPlayback}
                                muted={isMuted}
                                regions={[{
                                    id: loop.filename,
                                    start: loop.cropStart,
                                    end: loop.cropEnd || loop.duration || 10, // Default to 10s if duration unknown
                                    color: 'rgba(6, 182, 212, 0.3)' // Cyan transparent
                                }]}
                                onRegionChange={(_, start, end) => updateCrop(loop.filename, start, end)}
                                height={128}
                                zoomviewHeight={128}
                                overviewHeight={48}
                            />

                            {/* Mixer Overlay */}
                            <div style={{ position: 'absolute', top: 6, right: 6, display: 'flex', gap: 4, zIndex: 20 }}>
                                <RetroButton
                                    active={playingId === loop.filename}
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        if (playingId === loop.filename) {
                                            setPlayingId(null);
                                        } else {
                                            setPlayingId(loop.filename);
                                        }
                                    }}
                                    style={{ width: 40, height: 20, padding: 0, fontSize: 9 }}
                                >
                                    {playingId === loop.filename ? 'STOP' : 'PLAY'}
                                </RetroButton>
                                <RetroButton
                                    active={mix.mute}
                                    variant="danger"
                                    onClick={(e) => { e.stopPropagation(); toggleMute(loop.filename) }}
                                    style={{ width: 20, height: 20, padding: 0, fontSize: 9 }}
                                >M</RetroButton>
                                <RetroButton
                                    active={mix.solo}
                                    onClick={(e) => { e.stopPropagation(); toggleSolo(loop.filename) }}
                                    style={{ width: 20, height: 20, padding: 0, fontSize: 9 }}
                                >S</RetroButton>
                            </div>
                        </div>
                    )
                })}

                {/* Groove Transfer Panel - appears after loops are generated */}
                {phase === 'review' && loops.length > 0 && sessionId && (
                    <GrooveTransferPanel
                        sessionId={sessionId}
                        loops={loops.map(l => ({
                            filename: l.filename,
                            role: l.role,
                            bpm: l.bpm
                        }))}
                        onGrooveApplied={() => {
                            // Refresh the session to get the new grooved file
                            setTimeout(async () => {
                                try {
                                    const data = await forgeApi.getStatus(sessionId);
                                    if (data.results) {
                                        const newLoops: LoopViewModel[] = data.results.map((r: any) => ({
                                            id: r.filename,
                                            filename: r.filename,
                                            role: r.role,
                                            bpm: r.bpm || 120,
                                            key: r.key || 'C min',
                                            path: r.path,
                                            bars: r.bars || 4,
                                            selected: true,
                                            duration: r.duration || null,
                                            cropStart: 0,
                                            cropEnd: r.duration || 0,
                                            gain: 0,
                                            loopPlayback: true,
                                            transients: r.transients || [],
                                            tags: r.tags || [],
                                            texture: r.texture,
                                            dna: r.dna,
                                            shift_amount: r.shift_amount,
                                            effect_chain: r.effect_chain
                                        }));
                                        setLoops(newLoops);
                                        addLog('Groove applied - new file added to session');
                                    }
                                } catch (e) {
                                    console.error('Failed to refresh after groove transfer', e);
                                }
                            }, 500);
                        }}
                    />
                )}

                {/* Session Player - synchronized playback mixer */}
                {phase === 'review' && loops.length > 0 && sessionId && (
                    <SessionPlayer
                        sessionId={sessionId}
                        loops={loops}
                        rhythmAnchor={rhythmAnchor}
                        harmonicAnchor={harmonicAnchor}
                    />
                )}
            </main>
        </div>

        {/* FOOTER */}
        <footer className="rack-footer justify-between">
            <div className="flex gap-4">
                <span>STATUS: <span style={{ color: 'var(--accent-primary)' }}>{stage.toUpperCase()}</span></span>
                <span>PROGRESS: <span style={{ color: 'var(--accent-primary)' }}>{progress}%</span></span>
            </div>
            <RetroButton
                onClick={downloadSelection}
                disabled={!selectedLoops.length}
            >
                {downloadStatus === 'ready' ? 'DOWNLOAD SELECTION' : downloadStatus.toUpperCase()}
            </RetroButton>
        </footer>
    </div>
)
}